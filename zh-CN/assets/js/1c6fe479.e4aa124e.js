"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[71],{3905:(e,t,o)=>{o.d(t,{Zo:()=>c,kt:()=>f});var n=o(7294);function r(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function a(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function s(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?a(Object(o),!0).forEach((function(t){r(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function i(e,t){if(null==e)return{};var o,n,r=function(e,t){if(null==e)return{};var o,n,r={},a=Object.keys(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||(r[o]=e[o]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)o=a[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(r[o]=e[o])}return r}var l=n.createContext({}),d=function(e){var t=n.useContext(l),o=t;return e&&(o="function"==typeof e?e(t):s(s({},t),e)),o},c=function(e){var t=d(e.components);return n.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var o=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=d(o),f=r,h=u["".concat(l,".").concat(f)]||u[f]||p[f]||a;return o?n.createElement(h,s(s({ref:t},c),{},{components:o})):n.createElement(h,s({ref:t},c))}));function f(e,t){var o=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=o.length,s=new Array(a);s[0]=u;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:r,s[1]=i;for(var d=2;d<a;d++)s[d]=o[d];return n.createElement.apply(null,s)}return n.createElement.apply(null,o)}u.displayName="MDXCreateElement"},8749:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>a,metadata:()=>i,toc:()=>d});var n=o(7462),r=(o(7294),o(3905));const a={},s=void 0,i={unversionedId:"how-to-deploy-on-k8s/uniffle-operator-design",id:"how-to-deploy-on-k8s/uniffle-operator-design",title:"uniffle-operator-design",description:"\x3c!--",source:"@site/docs/04-how-to-deploy-on-k8s/00-uniffle-operator-design.md",sourceDirName:"04-how-to-deploy-on-k8s",slug:"/how-to-deploy-on-k8s/uniffle-operator-design",permalink:"/zh-CN/docs/how-to-deploy-on-k8s/uniffle-operator-design",draft:!1,editUrl:"https://github.com/apache/incubator-uniffle/docs/04-how-to-deploy-on-k8s/00-uniffle-operator-design.md",tags:[],version:"current",lastUpdatedBy:"roryqi",lastUpdatedAt:1666578200,formattedLastUpdatedAt:"2022/10/24",sidebarPosition:0,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"hardware-provisioning",permalink:"/zh-CN/docs/deploy-uniffle-cluster/hardware-provisioning"},next:{title:"install",permalink:"/zh-CN/docs/how-to-deploy-on-k8s/install"}},l={},d=[{value:"Summary",id:"summary",level:2},{value:"Motivation",id:"motivation",level:2},{value:"Goals",id:"goals",level:2},{value:"Design Details",id:"design-details",level:2},{value:"CRD Definition",id:"crd-definition",level:2},{value:"State Transition",id:"state-transition",level:2}],c={toc:d};function p(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"uniffle-operator-design"},"Uniffle Operator Design"),(0,r.kt)("h2",{id:"summary"},"Summary"),(0,r.kt)("p",null,"The purpose is to develop an operator to facilitate the rapid deployment of Uniffle in kubernetes environments."),(0,r.kt)("h2",{id:"motivation"},"Motivation"),(0,r.kt)("p",null,"Using the advantages of kubernetes in container orchestration, elastic scaling, and rolling upgrades, uniffle can more\neasily manage coordinator and shuffle server clusters."),(0,r.kt)("p",null,"In addition, based on the operating characteristics of shuffle servers, we hope to achieve safe offline:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Before a shuffle server is scaled down or upgraded, it should be added to the Coordinator's blacklist in advance."),(0,r.kt)("li",{parentName:"ol"},"After ensuring that the number of remaining applications is 0, allow its corresponding pod to be deleted and removed\nfrom the blacklist.")),(0,r.kt)("p",null,"We don't just want to simply pull up the coordinators and shuffle servers, but also ensure that running jobs are not\naffected. Therefore, we decided to develop an operator specifically."),(0,r.kt)("h2",{id:"goals"},"Goals"),(0,r.kt)("p",null,"Operator will implement the following functions:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Normally pull up two coordinator deployments (to ensure active-active) and a shuffle server statefulSet."),(0,r.kt)("li",{parentName:"ol"},"Supports replica expansion and upgrade of coordinators and shuffle servers, among which shuffle server also supports\ngrayscale upgrade."),(0,r.kt)("li",{parentName:"ol"},"Using the webhook mechanism, before a shuffle server is deleted, add its name to the coordinator's blacklist, and\ncheck the number of applications remaining running, and then release the pod deletion request after ensuring safety.")),(0,r.kt)("h2",{id:"design-details"},"Design Details"),(0,r.kt)("p",null,"This operator consists of two components: a crd controller and a webhook that admits crd and pod requests."),(0,r.kt)("p",null,"The crd controller observes the status changes of the crd and controls the workload changes."),(0,r.kt)("p",null,"The webhook verifies the changes of the crd, and admits the pod deletion request according to whether the number of\nremaining applications is 0."),(0,r.kt)("p",null,"The webhook will add the pod to be deleted to the coordinator's blacklist. When the pod is actually deleted, the\ncontroller will remove it from the blacklist."),(0,r.kt)("h2",{id:"crd-definition"},"CRD Definition"),(0,r.kt)("p",null,"An example of a crd object is as follows\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: uniffle.apache.org/v1alpha1\nkind: RemoteShuffleService\nmetadata:\n  name: rss-demo\n  namespace: kube-system\nspec:\n  # ConfigMapName indicates configMap name stores configurations of coordinators and shuffle servers.\n  configMapName: rss-demo\n  # Coordinator represents the relevant configuration of the coordinators.\n  coordinator:\n    # Image represents the mirror image used by coordinators.\n    image: ${coordinator-image}\n    # InitContainerImage is optional, mainly for non-root users to initialize host path permissions.\n    initContainerImage: "busybox:latest"\n    # Count is the number of coordinator workloads to be generated.\n    # By default, we will deploy two coordinators to ensure active-active.\n    count: 2\n    # RpcNodePort represents the port required by the rpc protocol of the coordinators,\n    # and the range is the same as the port range of the NodePort type service in kubernetes.\n    # By default, we will deploy two coordinators to ensure active-active.\n    rpcNodePort:\n      - 30001\n      - 30011\n    # httpNodePort represents the port required by the http protocol of the coordinators,\n    # and the range is the same as the port range of the NodePort type service in kubernetes.\n    # By default, we will deploy two coordinators to ensure active-active.\n    httpNodePort:\n      - 30002\n      - 30012\n    # XmxSize indicates the xmx size configured for coordinators.\n    xmxSize: "10G"\n    # ConfigDir records the directory where the configuration of coordinators reside.\n    configDir: "/data/rssadmin/rss/conf"\n    # Replicas field is the replicas of each coordinator\'s deployment.\n    replicas: 1\n    # ExcludeNodesFilePath indicates exclude nodes file path in coordinators\' containers.\n    excludeNodesFilePath: "/data/rssadmin/rss/coo/exclude_nodes"\n    # SecurityContext holds pod-level security attributes and common container settings.\n    securityContext:\n      # RunAsUser specifies the user ID of all processes in coordinator pods.\n      runAsUser: 1000\n      # FsGroup specifies the group ID of the owner of the volume within coordinator pods.\n      fsGroup: 1000\n    # LogHostPath represents the host path used to save logs of coordinators.\n    logHostPath: "/data/logs/rss"\n    # HostPathMounts field indicates host path volumes and their mounting path within coordinators\' containers.\n    hostPathMounts:\n      /data/logs/rss: /data/rssadmin/rss/logs\n  # shuffleServer represents the relevant configuration of the shuffleServers\n  shuffleServer:\n    # Sync marks whether the shuffle server needs to be updated or restarted.\n    # When the user needs to update the shuffle servers, it needs to be set to true.\n    # After the update is successful, the controller will modify it to false.\n    sync: true\n    # Replicas field is the replicas of each coordinator\'s deployment.\n    replicas: 3\n    # Image represents the mirror image used by shuffle servers.\n    image: ${shuffle-server-image}\n')),(0,r.kt)("p",null,"After a user creates a rss object, the rss-controller component will create the corresponding workloads."),(0,r.kt)("p",null,"For coordinators, the user directly modifies the rss object, and the controller synchronizes the corresponding state to\nthe workloads."),(0,r.kt)("p",null,"For shuffle servers, only by changing the spec.shuffleServer.sync field to true, the controller will apply the\ncorresponding updates to the workloads."),(0,r.kt)("p",null,"If you want more examples, please read more in ",(0,r.kt)("a",{parentName:"p",href:"/zh-CN/docs/how-to-deploy-on-k8s/examples"},"examples"),"."),(0,r.kt)("h2",{id:"state-transition"},"State Transition"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"state transition",src:o(2902).Z,width:"1864",height:"1158"})))}p.isMDXComponent=!0},2902:(e,t,o)=>{o.d(t,{Z:()=>n});const n=o.p+"assets/images/rss-crd-state-transition-330944efa8bb505a5f33e6fa07a66365.png"}}]);